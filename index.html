<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forex Broadcast Manager</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="style.css">

</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container-fluid px-3">
      <a class="navbar-brand" href="#">
        <i class="fas fa-chart-line me-2"></i>
        <span class="d-none d-sm-inline">FOREX BROADCAST</span>
        <span class="d-inline d-sm-none">FX</span>
      </a>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text">
          <i class="fas fa-circle text-success me-1"></i>
          <span id="connectionStatus" class="d-none d-md-inline">Connected</span>
        </span>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-3 py-4">
    <!-- Main Content -->
    <div class="row">
      <!-- Message Builder - Main Focus -->
      <div class="col-lg-8">
        <!-- Message Builder Card -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="fas fa-edit me-2"></i>
              Message Builder
            </h5>
            <div class="d-flex gap-2">
              <span class="badge bg-primary" id="selectedCount">0 selected</span>
              <span class="badge bg-success" id="onlineCount">0 online</span>
            </div>
          </div>
          <div class="card-body">
            <!-- Message Options -->
            <div class="mb-4">
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
                <h6 class="mb-0">Choose Your Approach</h6>
                <button class="btn btn-outline-primary btn-sm" id="createTemplateBtn">
                  <i class="fas fa-plus me-1"></i>Create New Template
                </button>
              </div>
              
              <!-- Template Selection -->
              <div class="d-flex flex-wrap gap-2 mb-3">
                <button class="btn btn-outline-primary btn-sm template-btn" data-template="realNumber">
                  <i class="fas fa-shield-alt me-1"></i>Real Number
                </button>
                <button class="btn btn-outline-primary btn-sm template-btn" data-template="privacyRequest">
                  <i class="fas fa-lock me-1"></i>Privacy
                </button>
                <button class="btn btn-outline-primary btn-sm template-btn" data-template="telegramCTA">
                  <i class="fas fa-telegram me-1"></i>Telegram CTA
                </button>
                <button class="btn btn-outline-primary btn-sm template-btn" data-template="fullStrategy">
                  <i class="fas fa-rocket me-1"></i>Full Strategy
                </button>
              </div>
              
              <!-- Template Creation Form (Hidden by default) -->
              <div id="templateCreationForm" class="card bg-light" style="display: none;">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <label for="templateName" class="form-label">Template Name</label>
                      <input type="text" class="form-control" id="templateName" placeholder="e.g., Welcome Message">
                    </div>
                    <div class="col-md-6">
                      <label for="templateCategory" class="form-label">Category</label>
                      <select class="form-select" id="templateCategory">
                        <option value="greeting">Greeting</option>
                        <option value="followup">Follow-up</option>
                        <option value="promotion">Promotion</option>
                        <option value="custom">Custom</option>
                      </select>
                    </div>
                  </div>
                  <div class="mt-3">
                    <label for="templateContent" class="form-label">Template Content</label>
                    <textarea class="form-control" id="templateContent" rows="4" placeholder="Enter your template content here..."></textarea>
                    <div class="mt-2 d-flex gap-2">
                      <button class="btn btn-success btn-sm" id="saveTemplateBtn">
                        <i class="fas fa-save me-1"></i>Save Template
                      </button>
                      <button class="btn btn-secondary btn-sm" id="cancelTemplateBtn">
                        <i class="fas fa-times me-1"></i>Cancel
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Message Input -->
            <div class="mb-4">
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-2 gap-2">
                <h6 class="mb-0">OR Write Your Own Message</h6>
                <div class="d-flex flex-wrap gap-1">
                  <button class="btn btn-outline-primary btn-sm" id="insertTemplateBtn">
                    <i class="fas fa-magic me-1"></i><span class="d-none d-sm-inline">Process with AI</span><span class="d-inline d-sm-none">AI</span>
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" id="clearMessageBtn" title="Clear Message">
                    <i class="fas fa-eraser"></i>
                  </button>
                  <button class="btn btn-outline-info btn-sm" id="previewMessageBtn" title="Preview Message">
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
              </div>
              
              <!-- Template Preview -->
              <div id="templatePreview" class="alert alert-info mb-3" style="display: none;">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <strong><i class="fas fa-eye me-1"></i>Template Preview:</strong>
                    <div id="templatePreviewContent" class="mt-1 small"></div>
                  </div>
                  <button type="button" class="btn-close" id="closePreview"></button>
                </div>
              </div>
              
              <textarea class="form-control" id="customMessage" rows="10" placeholder="Write your message here... (You can select a template above OR write your own message, then click 'Process with AI')" 
                        data-autocomplete="true" data-suggestions="Hey,Hello,Hi there,Welcome,Thank you,Best regards,Looking forward,Let me know,Please,Thanks"></textarea>
              <div class="d-flex justify-content-between mt-2">
                <small class="text-muted">Characters: <span id="charCount">0</span></small>
                <small class="text-muted">Lines: <span id="lineCount">1</span></small>
              </div>
            </div>

            <!-- Configure & Prepare -->
            <div class="mb-4">
              <h6 class="mb-3">Configure & Prepare</h6>
              <div class="row g-3">
                <div class="col-12 col-md-8">
                  <label for="telegramLink" class="form-label fw-bold">Telegram Link</label>
                  <input type="url" class="form-control" id="telegramLink" placeholder="https://t.me/yourchannel" 
                  value="https://t.me/tradetabofficial">
                </div>
                <div class="col-12 col-md-4">
                  <button class="btn btn-primary w-100" id="prepareBroadcast">
                    <i class="fas fa-cog me-1"></i>
                    <span class="d-none d-sm-inline">Prepare Broadcast</span>
                    <span class="d-inline d-sm-none">Prepare</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Send Button -->
            <div class="d-grid">
              <button class="btn btn-success btn-lg" id="sendBroadcast" disabled>
                <i class="fas fa-paper-plane me-2"></i>
                Send Broadcast
              </button>
            </div>

            <!-- Progress -->
            <div class="mt-3">
              <div class="progress" style="height: 6px;">
                <div class="progress-bar" id="broadcastProgress" role="progressbar" style="width: 0%"></div>
              </div>
              <small class="text-secondary" id="progressText">Ready to broadcast</small>
            </div>
          </div>
        </div>

        <!-- Recipients Selection - Compact -->
        <div class="card">
          <div class="card-header">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
              <h5 class="mb-0">
                <i class="fas fa-users me-2"></i>
                Recipients
              </h5>
              <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-lg-auto">
                <div class="d-flex gap-2">
                  <input type="text" class="form-control form-control-sm" id="searchContacts" placeholder="Search..." style="min-width: 120px;">
                  <select class="form-select form-select-sm" id="statusFilter" style="min-width: 80px;">
                    <option value="">All</option>
                    <option value="online">Online</option>
                    <option value="offline">Offline</option>
                    <option value="pending">Pending</option>
                  </select>
                </div>
                <div class="d-flex gap-3">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="selectAllContacts">
                    <label class="form-check-label" for="selectAllContacts">All</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="onlineContactsOnly">
                    <label class="form-check-label" for="onlineContactsOnly">Online</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body p-2">
            <div id="contactsList" class="row g-2">
              <!-- Contacts will be loaded here -->
            </div>
            
            <!-- Pagination -->
            <nav class="mt-3">
              <ul class="pagination justify-content-center pagination-sm" id="pagination"></ul>
            </nav>
          </div>
        </div>
      </div>

      <!-- Sidebar - Compact -->
      <div class="col-lg-4">
        <!-- Add Prospect - Compact -->
        <div class="card mb-3">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="fas fa-user-plus me-2"></i>
              Add Prospect
            </h6>
          </div>
          <div class="card-body p-3">
            <form id="contactForm">
              <div class="mb-2">
                <input type="text" class="form-control form-control-sm" id="contactName" placeholder="Name" required>
              </div>
              <div class="mb-2">
                <input type="tel" class="form-control form-control-sm" id="contactPhone" placeholder="Phone" required>
              </div>
              <button type="submit" class="btn btn-primary btn-sm w-100">
                <i class="fas fa-plus me-1"></i>
                Add
              </button>
            </form>
      </div>
    </div>

        <!-- Quick Stats - Compact -->
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="fas fa-chart-pie me-2"></i>
              Stats
            </h6>
          </div>
          <div class="card-body p-3">
            <div class="row text-center">
              <div class="col-4">
                <h6 class="text-primary mb-1" id="totalContacts">0</h6>
                <small class="text-muted">Total</small>
              </div>
              <div class="col-4">
                <h6 class="text-success mb-1" id="sentMessages">0</h6>
                <small class="text-muted">Sent</small>
            </div>
              <div class="col-4">
                <h6 class="text-warning mb-1" id="conversionRate">0%</h6>
                <small class="text-muted">Rate</small>
              </div>
            </div>
          </div>
              </div>
            </div>
          </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container"></div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    class ForexBroadcastManager {
      constructor() {
        this.API_ENDPOINTS = {
          contacts: "https://ttsupport-n8n.rfi9up.easypanel.host/webhook/3cd6b9c9-5586-46e6-9ffc-0b8f5465b6de",
          addContact: "https://ttsupport-n8n.rfi9up.easypanel.host/webhook/0dc54efc-986c-4a67-a32e-0a1feb7735d2",
          createMessage: "https://ttsupport-n8n.rfi9up.easypanel.host/webhook/131f8084-7fd7-41e7-bac7-717370210773",
          sendMessage: "https://ttsupport-n8n.rfi9up.easypanel.host/webhook/22373b13-d0e2-4eec-a972-bc93c3de6f99"
        };
        
        this.contacts = [];
        this.currentPage = 1;
        this.contactsPerPage = 10;
        this.broadcastQueue = [];
        this.isBroadcasting = false;
        this.telegramLink = "https://t.me/tradetabofficial";
        this.selectedTemplate = null;
        this.isPrepared = false;
        this.customTemplates = {};
        
        this.init();
      }

      init() {
        this.bindEvents();
        this.loadContacts();
        this.updateStats();
        this.loadMessageTemplates();
        this.updateQuickStats();
      }

      bindEvents() {
        // Contact form
        $('#contactForm').on('submit', (e) => {
          e.preventDefault();
          this.addContact();
        });

        // Search and filter
        $('#searchContacts').on('input', () => this.filterContacts());
        $('#statusFilter').on('change', () => this.filterContacts());

        // Broadcast actions
        $('#prepareBroadcast').on('click', () => this.prepareBroadcast());
        $('#sendBroadcast').on('click', () => this.sendBroadcast());
        
        // Message actions
        $('#insertTemplateBtn').on('click', () => this.insertTemplate());
        $('#clearMessageBtn').on('click', () => this.clearMessage());
        $('#previewMessageBtn').on('click', () => this.previewMessage());
        
        // Selection controls
        $('#selectAllContacts').on('change', () => this.toggleSelectAll());
        $('#onlineContactsOnly').on('change', () => this.toggleOnlineOnly());
        
        // Telegram link
        $('#telegramLink').on('input', (e) => {
          this.telegramLink = e.target.value;
          this.updateMessagePreview();
        });

        // Message textarea with character count
        $('#customMessage').on('input', () => {
          this.updateCharCount();
          this.isPrepared = false;
          $('#prepareBroadcast').prop('disabled', false);
          $('#sendBroadcast').prop('disabled', true);
          // Keep Insert Template enabled if a template is selected
          this.updateInsertTemplateButton();
        });

        // Template selection - NEW BUTTONS
        $('.template-btn').on('click', (e) => {
          const template = $(e.currentTarget).data('template');
          this.selectTemplate(template);
        });

        // Template creation
        $('#createTemplateBtn').on('click', () => this.showTemplateCreation());
        $('#saveTemplateBtn').on('click', () => this.saveTemplate());
        $('#cancelTemplateBtn').on('click', () => this.hideTemplateCreation());
        
        // Template preview
        $('#closePreview').on('click', () => this.hideTemplatePreview());

        // Pagination
        $(document).on('click', '.pagination .page-link', (e) => {
          e.preventDefault();
          const page = parseInt($(e.target).text());
          this.goToPage(page);
        });
      }

      selectTemplate(template) {
        // Remove previous selection
        $('.template-btn').removeClass('active');
        
        // Add selection to clicked template
        $(`.template-btn[data-template="${template}"]`).addClass('active');
        
        this.selectedTemplate = template;
        this.showTemplatePreview();
        this.updateInsertTemplateButton();
      }

      showTemplatePreview() {
        if (this.selectedTemplate) {
          let content = '';
          
          // Check if it's a custom template
          if (this.customTemplates && this.customTemplates[this.selectedTemplate]) {
            content = this.customTemplates[this.selectedTemplate].content;
          } else if (this.messageTemplates[this.selectedTemplate]) {
            content = this.messageTemplates[this.selectedTemplate];
          }
          
          if (content) {
            // Show preview in the preview area
            $('#templatePreviewContent').text(content);
            $('#templatePreview').slideDown(300);
            this.showToast(`Template "${this.getTemplateName()}" selected. Click "Insert Template" to process with AI.`, 'info');
          }
        }
      }

      hideTemplatePreview() {
        $('#templatePreview').slideUp(300);
      }

      getTemplateName() {
        if (this.customTemplates && this.customTemplates[this.selectedTemplate]) {
          return this.customTemplates[this.selectedTemplate].name;
        }
        
        const templateNames = {
          realNumber: 'Real Number',
          privacyRequest: 'Privacy Request',
          telegramCTA: 'Telegram CTA',
          fullStrategy: 'Full Strategy'
        };
        
        return templateNames[this.selectedTemplate] || 'Template';
      }

      updateInsertTemplateButton() {
        const hasTemplate = this.selectedTemplate !== null;
        const hasContent = $('#customMessage').val().trim().length > 0;
        
        // Enable if either template is selected OR user has written content
        const canProcess = hasTemplate || hasContent;
        $('#insertTemplateBtn').prop('disabled', !canProcess);
        
        // Update button text based on state
        if (hasTemplate && hasContent) {
          $('#insertTemplateBtn').html('<i class="fas fa-magic me-1"></i>Process Template + Message');
        } else if (hasTemplate) {
          $('#insertTemplateBtn').html('<i class="fas fa-magic me-1"></i>Process Template');
        } else if (hasContent) {
          $('#insertTemplateBtn').html('<i class="fas fa-magic me-1"></i>Process Message');
        } else {
          $('#insertTemplateBtn').html('<i class="fas fa-magic me-1"></i>Process with AI');
        }
      }

      loadMessageTemplates() {
        const templates = {
          realNumber: "Hey! This is my real number. I'm a professional Forex trader with proven strategies that generate consistent profits. Please don't share this number with anyone else - I only work with serious traders.",
          privacyRequest: "IMPORTANT: This is my private trading number. Please keep it confidential and don't share it with others. I only work with dedicated traders who are serious about their success.",
          telegramCTA: `Ready to access my exclusive trading strategies and real-time signals? Join my private Telegram channel for professional insights: ${this.telegramLink}`,
          fullStrategy: `Hey! This is my real trading number. I'm a professional Forex trader with proven strategies that generate consistent profits. Please don't share this number with anyone else - I only work with serious traders.\n\nReady to access my exclusive trading strategies and real-time signals? Join my private Telegram channel: ${this.telegramLink}`
        };

        this.messageTemplates = templates;
      }

      loadMessageTemplate() {
        // This method now just enables the Insert Template button
        // The actual template insertion happens when Insert Template is clicked
        // This allows users to see what template is selected before processing
      }

      updateCharCount() {
        const text = $('#customMessage').val();
        const charCount = text.length;
        const lineCount = text.split('\n').length;
        
        $('#charCount').text(charCount);
        $('#lineCount').text(lineCount);
      }

      showTemplateCreation() {
        $('#templateCreationForm').slideDown(300);
        $('#createTemplateBtn').prop('disabled', true);
      }

      hideTemplateCreation() {
        $('#templateCreationForm').slideUp(300);
        $('#createTemplateBtn').prop('disabled', false);
        this.clearTemplateForm();
      }

      clearTemplateForm() {
        $('#templateName').val('');
        $('#templateCategory').val('greeting');
        $('#templateContent').val('');
      }

      saveTemplate() {
        const name = $('#templateName').val().trim();
        const category = $('#templateCategory').val();
        const content = $('#templateContent').val().trim();

        if (!name || !content) {
          this.showToast('Please fill in template name and content', 'warning');
          return;
        }

        // Create a new template button
        const templateId = 'custom_' + Date.now();
        const templateBtn = `
          <button class="btn btn-outline-success btn-sm template-btn" data-template="${templateId}">
            <i class="fas fa-file-text me-1"></i>${name}
          </button>
        `;

        // Add the new template button
        $('.template-btn').last().after(templateBtn);

        // Store the template
        if (!this.customTemplates) {
          this.customTemplates = {};
        }
        this.customTemplates[templateId] = {
          name: name,
          category: category,
          content: content
        };

        // Bind click event to new button
        $(`.template-btn[data-template="${templateId}"]`).on('click', (e) => {
          const template = $(e.currentTarget).data('template');
          this.selectTemplate(template);
        });

        this.hideTemplateCreation();
        this.showToast(`Template "${name}" saved successfully!`, 'success');
      }

      updateMessagePreview() {
        if (this.selectedTemplate) {
          this.loadMessageTemplate();
        }
      }

      async loadContacts() {
        try {
          this.showLoading(true);
          const response = await $.get(this.API_ENDPOINTS.contacts);
          this.contacts = response.phones.map(item => ({
            ...item.json,
            id: Math.random().toString(36).substr(2, 9),
            status: this.getRandomStatus(),
            selected: false
          }));
          this.displayContacts();
          this.updateStats();
          this.updateQuickStats();
        } catch (error) {
          this.showToast('Error loading contacts', 'error');
        } finally {
          this.showLoading(false);
        }
      }

      async addContact() {
        const name = $('#contactName').val().trim();
        const phone = $('#contactPhone').val().trim();

        if (!name || !phone) {
          this.showToast('Please fill in all fields', 'warning');
          return;
        }

        try {
          const newContact = { userName: name, phone };
          await $.ajax({
            url: this.API_ENDPOINTS.addContact,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(newContact)
          });

          $('#contactName').val('');
          $('#contactPhone').val('');
          this.loadContacts();
          this.showToast('Contact added successfully', 'success');
        } catch (error) {
          this.showToast('Error adding contact', 'error');
        }
      }

      displayContacts() {
        const start = (this.currentPage - 1) * this.contactsPerPage;
        const end = start + this.contactsPerPage;
        const pageContacts = this.contacts.slice(start, end);

        const contactsHtml = pageContacts.map(contact => `
          <div class="col-md-6 col-lg-4">
            <div class="contact-item-compact d-flex align-items-center p-2 border rounded">
              <div class="form-check me-2">
                <input class="form-check-input contact-checkbox" type="checkbox" 
                       value="${contact.id}" ${contact.selected ? 'checked' : ''}>
              </div>
              <span class="status-indicator status-${contact.status} me-2"></span>
              <div class="flex-grow-1">
                <div class="fw-bold text-primary small">${contact.userName}</div>
                <div class="text-secondary small">${contact.phone}</div>
              </div>
            </div>
          </div>
        `).join('');

        $('#contactsList').html(contactsHtml);
        this.generatePagination();
        this.bindContactCheckboxes();
        this.updateQuickStats();
      }

      generatePagination() {
        const totalPages = Math.ceil(this.contacts.length / this.contactsPerPage);
        let paginationHtml = '';

        for (let i = 1; i <= totalPages; i++) {
          paginationHtml += `
            <li class="page-item ${i === this.currentPage ? 'active' : ''}">
              <a class="page-link" href="#">${i}</a>
            </li>
          `;
        }

        $('#pagination').html(paginationHtml);
      }

      bindContactCheckboxes() {
        $('.contact-checkbox').on('change', (e) => {
          const contactId = $(e.target).val();
          const contact = this.contacts.find(c => c.id === contactId);
          if (contact) {
            contact.selected = $(e.target).is(':checked');
            this.updateQuickStats();
          }
        });
      }

      goToPage(page) {
        this.currentPage = page;
        this.displayContacts();
      }

      filterContacts() {
        const searchTerm = $('#searchContacts').val().toLowerCase();
        const statusFilter = $('#statusFilter').val();

        const filtered = this.contacts.filter(contact => {
          const matchesSearch = contact.userName.toLowerCase().includes(searchTerm) ||
                              contact.phone.includes(searchTerm);
          const matchesStatus = !statusFilter || contact.status === statusFilter;
          return matchesSearch && matchesStatus;
        });

        this.displayFilteredContacts(filtered);
      }

      displayFilteredContacts(filteredContacts) {
        const contactsHtml = filteredContacts.map(contact => `
          <div class="list-group-item contact-item d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <span class="status-indicator status-${contact.status}"></span>
              <div>
                <strong class="text-primary">${contact.userName}</strong>
                <br>
                <small class="text-secondary">${contact.phone}</small>
              </div>
            </div>
            <div class="form-check">
              <input class="form-check-input contact-checkbox" type="checkbox" 
                     value="${contact.id}" ${contact.selected ? 'checked' : ''}>
            </div>
          </div>
        `).join('');

        $('#contactsList').html(contactsHtml);
        this.bindContactCheckboxes();
      }

      toggleSelectAll() {
        const isChecked = $('#selectAllContacts').is(':checked');
        $('.contact-checkbox').prop('checked', isChecked);
        
        this.contacts.forEach(contact => {
          contact.selected = isChecked;
        });
        this.updateQuickStats();
      }

      toggleOnlineOnly() {
        const isOnlineOnly = $('#onlineContactsOnly').is(':checked');
        if (isOnlineOnly) {
          $('.contact-checkbox').each((index, checkbox) => {
            const contactId = $(checkbox).val();
            const contact = this.contacts.find(c => c.id === contactId);
            if (contact && contact.status !== 'online') {
              $(checkbox).prop('checked', false);
              contact.selected = false;
            }
          });
        }
        this.updateQuickStats();
      }

      prepareBroadcast() {
        const message = $('#customMessage').val().trim();

        if (!message) {
          this.showToast('Please select a template or enter a custom message first', 'warning');
          return;
        }

        const selectedContacts = this.contacts.filter(c => c.selected);
        if (selectedContacts.length === 0) {
          this.showToast('Please select at least one recipient', 'warning');
          return;
        }

        this.isPrepared = true;
        $('#prepareBroadcast').prop('disabled', true);
        $('#sendBroadcast').prop('disabled', false);
        this.showToast(`Ready to send to ${selectedContacts.length} recipients`, 'success');
      }

      async insertTemplate() {
        const hasTemplate = this.selectedTemplate !== null;
        const hasContent = $('#customMessage').val().trim().length > 0;
        
        if (!hasTemplate && !hasContent) {
          this.showToast('Please select a template or write a message first', 'warning');
          return;
        }

        try {
          $('#insertTemplateBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Processing...');
          
          let contentToProcess = '';
          
          if (hasTemplate) {
            // Get the template content
            if (this.customTemplates && this.customTemplates[this.selectedTemplate]) {
              contentToProcess = this.customTemplates[this.selectedTemplate].content;
            } else if (this.messageTemplates[this.selectedTemplate]) {
              contentToProcess = this.messageTemplates[this.selectedTemplate];
            }
            
            // If user also wrote content, combine them
            if (hasContent) {
              const userContent = $('#customMessage').val().trim();
              contentToProcess = `${contentToProcess}\n\n${userContent}`;
            }
          } else {
            // User wrote their own message
            contentToProcess = $('#customMessage').val().trim();
          }

          // Send the content to the API for AI generation
          const response = await $.ajax({
            url: this.API_ENDPOINTS.createMessage,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
              "template": contentToProcess
            })
          });

          // Insert the AI-generated message
          if (response && response.message) {
            $('#customMessage').val(response.message);
          } else {
            // Fallback to original content if no AI response
            $('#customMessage').val(contentToProcess);
          }

          this.updateCharCount();
          this.isPrepared = false;
          $('#prepareBroadcast').prop('disabled', false);
          $('#sendBroadcast').prop('disabled', true);
          
          this.showToast('Content processed with AI successfully!', 'success');
          
        } catch (error) {
          this.showToast('Error processing content: ' + error.message, 'error');
        } finally {
          this.updateInsertTemplateButton();
        }
      }

      clearMessage() {
        $('#customMessage').val('');
        this.selectedTemplate = null;
        $('.template-btn').removeClass('active');
        this.hideTemplatePreview();
        this.updateCharCount();
        this.updateInsertTemplateButton();
        this.isPrepared = false;
        $('#prepareBroadcast').prop('disabled', false);
        $('#sendBroadcast').prop('disabled', true);
        this.showToast('Message cleared', 'info');
      }

      previewMessage() {
        const message = $('#customMessage').val().trim();
        if (!message) {
          this.showToast('No message to preview', 'warning');
          return;
        }

        // Create a modal for preview
        const previewModal = `
          <div class="modal fade" id="previewModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Message Preview</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="border rounded p-3 bg-light">
                    <pre style="white-space: pre-wrap; font-family: inherit;">${message}</pre>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
        `;

        // Remove existing modal if any
        $('#previewModal').remove();
        
        // Add and show modal
        $('body').append(previewModal);
        $('#previewModal').modal('show');
      }

      async sendBroadcast() {
        if (this.isBroadcasting || !this.isPrepared) return;

        const selectedContacts = this.contacts.filter(c => c.selected);
        if (selectedContacts.length === 0) {
          this.showToast('Please select at least one recipient', 'warning');
          return;
        }

        try {
          this.isBroadcasting = true;
          $('#sendBroadcast').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Sending...');

          // Send the message to the webhook
          await $.ajax({
            url: this.API_ENDPOINTS.sendMessage,
            type: 'GET'
          });

          this.showToast(`Broadcast sent to ${selectedContacts.length} recipients successfully!`, 'success');
          this.updateStats();
          
          // Reset form
          this.isPrepared = false;
          $('#prepareBroadcast').prop('disabled', false);
          $('#sendBroadcast').prop('disabled', true).html('<i class="fas fa-paper-plane me-1"></i>Send Broadcast');
          
        } catch (error) {
          this.showToast('Error sending broadcast: ' + error.message, 'error');
        } finally {
          this.isBroadcasting = false;
        }
      }

      updateStats() {
        $('#totalContacts').text(this.contacts.length);
        $('#sentMessages').text(Math.floor(Math.random() * 500) + 200);
        $('#conversionRate').text((Math.random() * 20 + 10).toFixed(1) + '%');
        $('#telegramClicks').text(Math.floor(Math.random() * 100) + 50);
      }

      updateQuickStats() {
        const selectedCount = this.contacts.filter(c => c.selected).length;
        const onlineCount = this.contacts.filter(c => c.status === 'online').length;
        
        $('#selectedCount').text(selectedCount);
        $('#onlineCount').text(onlineCount);
      }

      getRandomStatus() {
        const statuses = ['online', 'offline', 'pending'];
        return statuses[Math.floor(Math.random() * statuses.length)];
      }

      showToast(message, type = 'info') {
        const toastHtml = `
          <div class="toast show" role="alert">
            <div class="toast-header bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} text-white">
              <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
              ${message}
            </div>
          </div>
        `;

        $('.toast-container').append(toastHtml);
        
        setTimeout(() => {
          $('.toast-container .toast').remove();
        }, 5000);
      }

      showLoading(show) {
        if (show) {
          $('#contactsList').html('<div class="text-center py-4"><div class="spinner-border text-accent" role="status"></div><p class="mt-2">Loading...</p></div>');
        }
      }
    }

    // Initialize the application
    $(document).ready(() => {
      new ForexBroadcastManager();
    });
  </script>
</body>
</html>
